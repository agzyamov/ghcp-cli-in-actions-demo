name: Copilot Q&A

on:
  workflow_dispatch:
    inputs:
      question:
        description: 'Ask Copilot anything (e.g., "How do I implement rate limiting in Python?")'
        required: true
        type: string

jobs:
  ask-copilot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Copilot CLI
        run: |
          npm install -g @github/copilot
          npx @github/copilot --version
      
      - name: Ask Copilot
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          export GITHUB_TOKEN="${GITHUB_TOKEN}"
          export GH_TOKEN="${GH_TOKEN}"
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "❌ ERROR: No COPILOT_TOKEN secret found!"
            exit 1
          fi
          
          echo "🤖 Asking GitHub Copilot..."
          echo ""
          
          # Create response.md with question
          echo "# Copilot Response" > response.md
          echo "" >> response.md
          echo "**Question:** ${{ github.event.inputs.question }}" >> response.md
          echo "" >> response.md
          echo "**Asked:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> response.md
          echo "" >> response.md
          echo "---" >> response.md
          echo "" >> response.md
          
          # Get answer from Copilot and append to response.md
          GITHUB_TOKEN="${GITHUB_TOKEN}" GH_TOKEN="${GH_TOKEN}" npx @github/copilot \
            --allow-all-tools \
            -p "${{ github.event.inputs.question }}" \
            >> response.md 2>&1
          
          echo ""
          echo "✅ Response saved to response.md"
      
      - name: Display Response
        run: |
          echo ""
          echo "=== COPILOT RESPONSE ==="
          cat response.md
      
      - name: Commit Response
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create responses directory if it doesn't exist
          mkdir -p responses
          
          # Copy to timestamped file
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          cp response.md "responses/response_${TIMESTAMP}.md"
          
          # Switch to copilot-responses branch (create if doesn't exist)
          git fetch origin copilot-responses:copilot-responses 2>/dev/null || git checkout -b copilot-responses
          git checkout copilot-responses || git checkout -b copilot-responses
          
          git add response.md "responses/response_${TIMESTAMP}.md"
          git commit -m "Add Copilot response: ${{ github.event.inputs.question }}"
          git push -u origin copilot-responses
          
          echo "✅ Response committed to branch: copilot-responses"
      
      - name: Upload as Artifact
        uses: actions/upload-artifact@v5
        with:
          name: copilot-response
          path: response.md
      
      - name: Summary
        run: |
          echo "## ✅ Copilot Response Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Question:** ${{ github.event.inputs.question }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`copilot-responses\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files created:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`response.md\` (root directory)" >> $GITHUB_STEP_SUMMARY
          echo "- \`responses/response_$(date +%Y%m%d_%H%M%S).md\` (archived copy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All responses are stored in the \`copilot-responses\` branch." >> $GITHUB_STEP_SUMMARY
